name: Deploy Assembly Inspector

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:  # VÃµimaldab kÃ¤sitsi kÃ¤ivitada

env:
  NODE_VERSION: '18.x'

jobs:
  build-and-deploy:
    name: Build and Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout kood
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # 4. Create .env file from secrets
      - name: ğŸ” Create .env file
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" >> .env
          echo "VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}" >> .env
          echo "Environment file created"

      # 5. Build projekt
      - name: ğŸ”¨ Build project
        run: npm run build

      # 6. Verify build
      - name: âœ… Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found!"
            exit 1
          fi
          echo "Build output:"
          ls -la dist/

      # 7. Deploy to Vercel (VARIANT 1 - SOOVITATAV)
      - name: ğŸš€ Deploy to Vercel
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'
          working-directory: ./

      # Alternatiiv: Deploy to GitHub Pages (VARIANT 2)
      # Uncommenti see kui kasutad GitHub Pages'i
      # - name: ğŸš€ Deploy to GitHub Pages
      #   if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./dist
      #     cname: your-domain.com  # optional: kui sul on custom domain

      # Alternatiiv: Deploy to Netlify (VARIANT 3)
      # - name: ğŸš€ Deploy to Netlify
      #   if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      #   uses: nwtgck/actions-netlify@v2
      #   with:
      #     publish-dir: './dist'
      #     production-branch: main
      #     github-token: ${{ secrets.GITHUB_TOKEN }}
      #     deploy-message: "Deploy from GitHub Actions"
      #   env:
      #     NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      #     NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      # 8. Upload artifacts (backup)
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: assembly-inspector-build
          path: dist/
          retention-days: 7

      # 9. Deployment notification (optional)
      - name: ğŸ“¢ Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Build and deployment successful!"
          else
            echo "âš ï¸ Build completed but deployment may have been skipped (check if Vercel secrets are configured)"
          fi

  # Job: Test (optional, aga soovitatav)
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run linter
        run: npm run lint || echo "No lint script found, skipping..."

      # Uncomment kui lisad teste
      # - name: ğŸ§ª Run tests
      #   run: npm test

  # Job: Security scan (optional)
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Run npm audit
        run: npm audit --audit-level=moderate || true

      # - name: ğŸ”’ Run Snyk security scan
      #   uses: snyk/actions/node@master
      #   env:
      #     SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
